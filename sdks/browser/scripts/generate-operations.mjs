import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import YAML from 'yaml';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const specPath = path.resolve(__dirname, '../openapi.yaml');
const outPath = path.resolve(__dirname, '../src/operations.ts');

function toIdentifier(name) {
  const safe = String(name)
    .trim()
    .replace(/[^A-Za-z0-9_]+/g, '_')
    .replace(/^_+/, '')
    .replace(/_+$/, '');
  const withPrefix = /^[A-Za-z_]/.test(safe) ? safe : `_${safe}`;
  return withPrefix.length ? withPrefix : '_operation';
}

function uniqueName(base, used) {
  let candidate = base;
  let i = 2;
  while (used.has(candidate)) {
    candidate = `${base}_${i}`;
    i += 1;
  }
  used.add(candidate);
  return candidate;
}

const raw = await fs.readFile(specPath, 'utf8');
const spec = YAML.parse(raw);

const paths = spec?.paths ?? {};
const httpMethods = ['get', 'put', 'post', 'delete', 'options', 'head', 'patch', 'trace'];

const usedNames = new Set();
const operations = [];

for (const [apiPath, pathItem] of Object.entries(paths)) {
  if (!pathItem || typeof pathItem !== 'object') continue;

  for (const method of httpMethods) {
    const op = pathItem[method];
    if (!op || typeof op !== 'object') continue;

    const operationId = op.operationId ?? `${method}_${apiPath}`;
    const name = uniqueName(toIdentifier(operationId), usedNames);
    operations.push({ name, method, apiPath });
  }
}

operations.sort((a, b) => a.name.localeCompare(b.name));

const header = `/*
 * AUTO-GENERATED FILE
 *
 * This file is generated by ./scripts/generate-operations.mjs
 * Do not edit manually.
 */

import type { MaybeOptionalInit } from 'openapi-fetch';
import type { paths } from './openapi-types.js';
import type { PaystackClient } from './client.js';

type InitArg<T> = undefined extends T ? [init?: Exclude<T, undefined>] : [init: T];
`;

const fnBlocks = operations
  .map(({ name, method, apiPath }) => {
    const methodKey = method.toLowerCase();
    const methodUpper = method.toUpperCase();
    const typeExpr = `MaybeOptionalInit<paths[${JSON.stringify(apiPath)}], ${JSON.stringify(methodKey)}>`;

    return `
export function ${name}(client: PaystackClient, ...init: InitArg<${typeExpr}>) {
  return client.${methodUpper}(${JSON.stringify(apiPath)}, ...init);
}
`;
  })
  .join('');

const bindLines = operations
  .map(({ name, method, apiPath }) => {
    const methodKey = method.toLowerCase();
    const typeExpr = `MaybeOptionalInit<paths[${JSON.stringify(apiPath)}], ${JSON.stringify(methodKey)}>`;
    return `    ${name}: (...init: InitArg<${typeExpr}>) => ${name}(client, ...init),`;
  })
  .join('\n');

const footer = `
export function bindOperations(client: PaystackClient) {
  return {
${bindLines}
  } as const;
}
`;

const output = `${header}${fnBlocks}${footer}`;
await fs.writeFile(outPath, output);

console.log(`Generated ${operations.length} operations â†’ ${path.relative(process.cwd(), outPath)}`);
