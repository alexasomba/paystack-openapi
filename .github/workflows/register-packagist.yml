name: Register package on Packagist

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  register:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Register package on Packagist
        env:
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}
        run: |
          set -euo pipefail
          REPO_URL="https://github.com/alexasomba/paystack-php.git"
          echo "Registering $REPO_URL on Packagist..."
          http_status=$(curl -sS -o /tmp/resp -w "%{http_code}" -X POST -d "repository[url]=$REPO_URL" -H "Authorization: Bearer $PACKAGIST_TOKEN" https://packagist.org/api/create || true)
          echo "Response body:"; cat /tmp/resp || true
          echo "HTTP status: $http_status"
          if [ "$http_status" -ne 200 ] && [ "$http_status" -ne 201 ]; then
            echo "Packagist API returned non-success status $http_status"
            exit 1
          fi
