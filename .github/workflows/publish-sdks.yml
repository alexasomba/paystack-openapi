name: Publish SDKs

on:
  push:
    tags:
      - "v*"

jobs:
  publish-npm:
    name: Publish npm packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack and prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Install JS deps
        run: pnpm install --frozen-lockfile

      - name: Publish npm packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
          echo "npm auth check:"
          if npm whoami; then
            echo "npm auth OK"
          else
            echo "npm auth failed; showing npm config"
            npm config get //registry.npmjs.org/:_authToken
            exit 1
          fi
          echo "Attempting workspace publish"
          pnpm -r --filter "./sdks/*" --filter '!./sdks/python' --if-present publish:public || {
            echo "Workspace publish failed; attempting per-package publishes to continue."
            rc=0
            for pkg in sdks/*; do
              if [ -f "$pkg/package.json" ] && [ "$pkg" != "sdks/python" ]; then
                name=$(node -e "console.log(require('./$pkg/package.json').name)")
                version=$(node -e "console.log(require('./$pkg/package.json').version)")
                if npm view "${name}@${version}" >/dev/null 2>&1; then
                  echo "${name}@${version} already published, skipping"
                  continue
                fi
                echo "Publishing $pkg..."
                (cd "$pkg" && pnpm publish:public) || { echo "Publish failed for $pkg"; rc=1; }
              fi
            done
            if [ $rc -ne 0 ]; then
              echo "Some packages failed to publish"
              exit 1
            fi
          }

  publish-python:
    name: Publish Python package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Publish Python package
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m pip install --upgrade build twine
          cd sdks/python
          python -m build
          echo "Checking distributions against PyPI and uploading only new ones"
          python - <<'PY'
import re, sys, json, urllib.request, os
pkg_dir = 'dist'
if not os.path.isdir(pkg_dir):
    print('No distributions found')
    sys.exit(0)
files = sorted(os.listdir(pkg_dir))
to_upload = []
for fn in files:
    path = os.path.join(pkg_dir, fn)
    m = re.match(r'^(.+?)-(?P<version>\d+\.\d+\.\d+)', fn)
    if not m:
        print('WARN: could not parse filename', fn, 'â€” will include it for upload')
        to_upload.append(path)
        continue
    name = m.group(1)
    version = m.group('version')
    url = f'https://pypi.org/pypi/{name}/json'
    exists = False
    try:
        resp = urllib.request.urlopen(url, timeout=10)
        j = json.loads(resp.read().decode())
        exists = version in j.get('releases', {})
    except Exception:
        # if PyPI is unreachable or package not found, we assume upload is needed
        exists = False
    if exists:
        print('SKIP', fn)
    else:
        print('UPLOAD', fn)
        to_upload.append(path)
if not to_upload:
    print('No new distributions to upload; skipping twine upload')
    sys.exit(0)
print('Uploading files:', to_upload)
# Replace current process with twine upload so exit code propagates
os.execv(sys.executable, [sys.executable, '-m', 'twine', 'upload', '--non-interactive', '-u', '__token__', '-p', os.environ.get('PYPI_API_TOKEN','')] + to_upload)
PY
